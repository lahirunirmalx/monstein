name: PHP CI

on:
  push:
    branches: [ dev, main, master ]
  pull_request:
    branches: [ dev, main, master ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        php-version: ['7.4', '8.0', '8.1', '8.2', '8.3']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP ${{ matrix.php-version }}
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, pdo, json
        tools: composer:v2

    - name: Validate composer.json
      run: composer validate --strict

    - name: Check PHP syntax errors
      run: |
        echo "Checking PHP syntax for PHP ${{ matrix.php-version }}..."
        find app -name "*.php" -print0 | xargs -0 -n1 php -l
        find tests -name "*.php" -print0 | xargs -0 -n1 php -l
        echo "✓ No syntax errors found"

    - name: Check code structure
      run: |
        echo "Checking code structure..."
        
        # Check that all controllers extend base controllers
        for file in app/Controllers/*Controller.php; do
          if ! grep -q "extends.*Controller" "$file"; then
            echo "Warning: $file may not extend a base controller"
          fi
        done
        
        # Check that all models extend Eloquent Model
        for file in app/Models/*.php; do
          if ! grep -q "extends Model" "$file"; then
            echo "Warning: $file may not extend Eloquent Model"
          fi
        done
        
        echo "✓ Code structure check complete"

  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer:v2

    - name: Install dependencies
      run: composer update --prefer-dist --no-progress --no-interaction

    - name: Security audit
      run: composer audit

    - name: Check for hardcoded secrets
      run: |
        echo "Checking for potential hardcoded secrets..."
        
        # Check for hardcoded passwords (excluding comments and .env.example)
        if grep -rn "password.*=.*['\"].*['\"]" app/ --include="*.php" | grep -v "password_hash" | grep -v "PASSWORD_DEFAULT" | grep -v "//"; then
          echo "⚠ Warning: Potential hardcoded password found"
        fi
        
        # Check for hardcoded JWT secrets
        if grep -rn "secret.*=.*['\"][a-zA-Z0-9]" app/Config/ --include="*.php" | grep -v "env(" | grep -v "self::env" | grep -v "//"; then
          echo "⚠ Warning: Potential hardcoded secret found in Config"
        fi
        
        echo "✓ Security check complete"
